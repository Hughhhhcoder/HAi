# 🌐 局域网访问修复指南

## 📋 当前状态检查

### ✅ 已验证正常的功能
- **前端访问**: http://192.168.110.17:5174 ✅
- **后端API**: http://192.168.110.17:8000 ✅  
- **API代理**: http://192.168.110.17:5174/api/ ✅
- **CORS配置**: 已正确配置允许局域网访问 ✅
- **Docker网络**: 容器间通信正常 ✅

## 🔧 可能的问题和解决方案

### 1. 防火墙问题
如果无法访问，可能是macOS防火墙阻止了连接：

```bash
# 检查防火墙状态
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# 临时关闭防火墙（测试用）
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off

# 测试完成后重新开启
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
```

### 2. 网络配置问题
确保设备在同一局域网：

```bash
# 检查当前IP地址
ifconfig | grep "inet " | grep -v 127.0.0.1

# 如果IP地址变化，需要更新CORS配置
```

### 3. Docker网络问题
重启Docker服务：

```bash
# 重启所有服务
docker-compose down
docker-compose up -d

# 检查容器状态
docker ps

# 检查网络连接
docker network ls
docker network inspect hai_default
```

### 4. 端口占用问题
检查端口是否被占用：

```bash
# 检查端口占用
lsof -i :5174
lsof -i :8000

# 如果端口被占用，可以修改docker-compose.yml中的端口映射
```

## 🚀 快速修复步骤

### 步骤1: 重启服务
```bash
cd /Users/Hughhhh/projects/Hai
docker-compose down
docker-compose up -d
```

### 步骤2: 检查服务状态
```bash
# 检查容器状态
docker ps

# 检查日志
docker logs hai-frontend
docker logs hai-backend
```

### 步骤3: 测试连接
```bash
# 测试前端
curl http://192.168.110.17:5174

# 测试后端
curl http://192.168.110.17:8000/ping

# 测试API代理
curl http://192.168.110.17:5174/api/ai/roles
```

### 步骤4: 检查防火墙
```bash
# 检查防火墙状态
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# 如果防火墙开启，临时关闭测试
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off
```

## 📱 移动设备访问

### 确保设备连接同一Wi-Fi
1. 手机/平板连接与Mac相同的Wi-Fi网络
2. 在浏览器中访问: `http://192.168.110.17:5174`
3. 使用测试账号登录: `admin` / `admin123`

### 移动设备测试功能
- ✅ 用户登录/注册
- ✅ AI角色对话
- ✅ 图片上传
- ✅ 心理测评
- ✅ 每日打卡
- ✅ 历史记录查看

## 🔍 故障排查

### 问题1: 无法访问前端
**症状**: 浏览器显示"无法连接"或"连接超时"

**解决方案**:
```bash
# 检查前端容器
docker logs hai-frontend

# 检查端口映射
docker port hai-frontend

# 重启前端容器
docker-compose restart frontend
```

### 问题2: 前端可以访问但API报错
**症状**: 页面加载但功能无法使用，控制台显示CORS错误

**解决方案**:
```bash
# 检查后端容器
docker logs hai-backend

# 检查CORS配置
curl -H "Origin: http://192.168.110.17:5174" http://192.168.110.17:8000/api/ai/roles

# 重启后端容器
docker-compose restart backend
```

### 问题3: 数据库连接问题
**症状**: 登录失败或数据无法保存

**解决方案**:
```bash
# 检查数据库容器
docker logs hai-mysql

# 检查数据库连接
docker exec hai-mysql mysql -u hai -p -e "SHOW DATABASES;"

# 重启数据库容器
docker-compose restart mysql
```

## 🌟 优化建议

### 1. 固定IP地址
为了避免IP地址变化，建议在路由器中为Mac分配固定IP：

1. 登录路由器管理界面
2. 找到DHCP设置
3. 为Mac的MAC地址分配固定IP: `192.168.110.17`

### 2. 性能优化
```bash
# 增加Docker内存限制
# 在docker-compose.yml中添加:
deploy:
  resources:
    limits:
      memory: 2G
```

### 3. 安全配置
生产环境建议：
- 启用HTTPS
- 添加访问控制
- 配置防火墙规则

## 📞 技术支持

如果以上步骤都无法解决问题，请提供以下信息：

1. **错误信息**: 浏览器控制台的错误信息
2. **网络环境**: 路由器型号、网络配置
3. **设备信息**: 访问设备的操作系统和浏览器版本
4. **测试结果**: 运行`局域网测试.html`的结果

## 🎯 测试页面

访问测试页面验证所有功能：
- 打开: `http://192.168.110.17:5174/局域网测试.html`
- 运行所有测试项目
- 查看详细的诊断信息

---

**注意**: 如果IP地址发生变化，需要更新`backend/app/main.py`中的CORS配置，然后重启后端服务。
